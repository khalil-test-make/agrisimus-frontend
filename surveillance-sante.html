<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Surveillance & Sant√© - GreenTwin</title>

  <!-- Fonts & Frameworks -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet">

  <!-- Main style (same as index) -->
  <link rel="stylesheet" href="style.css">

  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <!-- NAVBAR (glass style like index) -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top nav-glass">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="index.html">
        <img src="images/greentwin-logo.png" alt="GreenTwin" class="logo me-2" onerror="this.style.display='none'">
        <span class="brand-title">GreenTwin</span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navCollapse">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navCollapse">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          <li class="nav-item"><a class="nav-link" href="index.html">Accueil</a></li>
          <li class="nav-item"><a class="nav-link" href="jumeau-virtuel.html">Mon Jumeau Virtuel</a></li>
          <li class="nav-item"><a class="nav-link active" href="surveillance-sante.html">Surveillance & Sant√©</a></li>
          <li class="nav-item"><a class="nav-link" href="previsions-irrigation.html">Pr√©visions & Irrigation</a></li>
          <li class="nav-item"><a class="nav-link btn btn-outline-success ms-2 d-none d-lg-inline" href="#contact">Contact</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <header class="hero">
    <div class="hero-overlay"></div>
    <div class="container hero-inner text-center">
      <h1 class="hero-title" data-aos="fade-down">Surveillance & Sant√© des Plantes</h1>
      <p class="hero-subtitle mb-4" data-aos="fade-up">D√©tectez les probl√®mes avant qu'ils ne s'aggravent gr√¢ce √† l'IA et aux capteurs.</p>
    </div>
  </header>

  <main>
    <!-- D√©tection pr√©coce - contenu conserv√© -->
    <section class="py-5">
      <div class="container">
        <div class="row align-items-center g-5">
          <div class="col-lg-6" data-aos="fade-right">
            <h2 class="section-heading"><i class="bi bi-camera-fill me-2"></i> D√©tection Pr√©coce des Maladies par IA</h2>
            <p class="lead">Gr√¢ce √† des capteurs visuels avanc√©s et des mod√®les d'IA, GreenTwin identifie les premiers signes de maladies, d'infestation ou de carences.</p>
            <p>Analyse des motifs foliaires, des couleurs et des textures pour g√©n√©rer des alertes exploitables.</p>
          </div>
          <div class="col-lg-6" data-aos="fade-left">
            <div class="glass-card p-3 text-center">
              <img src="https://placehold.co/600x400/2e8b57/ffffff?text=AI+Plant+Scan" alt="D√©tection IA" class="img-fluid rounded">
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Upload & ML (NO CHANGES to flow, only styled) -->
    <section class="py-5 section-soft">
      <div class="container">
        <h2 class="section-heading text-center"><i class="bi bi-robot me-2"></i> Diagnostic Imm√©diat de Feuille par IA</h2>

        <div class="row g-5 justify-content-center mt-4">
          <!-- Upload -->
          <div class="col-lg-5" data-aos="fade-right">
            <div class="glass-card p-4">
              <h5 class="mb-3 text-success"><i class="bi bi-upload me-2"></i> 1. Charger l'image</h5>
              <div class="text-center p-4 border rounded-3 bg-white position-relative">
                <input type="file" id="leafImageUpload" accept=".jpg,.jpeg,.png" style="display:none">
                <img id="imagePreview" src="https://placehold.co/400x300/e9ecef/212529?text=Cliquez+pour+t√©l√©verser+une+image" alt="aper√ßu" class="img-fluid rounded mb-3 prototype-iot-image" style="cursor:pointer; max-height:300px; object-fit:cover" onclick="document.getElementById('leafImageUpload').click()">
                <p class="text-muted mb-0"><i class="bi bi-file-earmark-image me-1"></i> JPG / PNG (max 5MB)</p>
              </div>

              <button id="startDiagnosisBtn" class="btn btn-primary btn-lg w-100 mt-4" disabled>
                <i class="bi bi-lightning-charge-fill me-2"></i> D√âMARRER LE DIAGNOSTIC
              </button>

              <div id="diagnosisAlert" class="alert alert-info mt-3 small" role="status">
                <i class="bi bi-lightbulb me-2"></i> **Note :** Diagnostic simul√© ‚Äî il renvoie une pr√©diction et une confiance.
              </div>
            </div>
          </div>

          <!-- R√©sultat ML -->
          <div class="col-lg-5" data-aos="fade-left">
            <div class="glass-card p-4">
              <h5 class="mb-3 text-success"><i class="bi bi-clipboard-data me-2"></i> 2. R√©sultat du Mod√®le ML</h5>
              <div id="resultArea" class="text-center bg-white border rounded-3 p-4" style="min-height:250px; display:flex; flex-direction:column; justify-content:center;">
                <div id="diagnosisLoading" class="spinner-border text-success mb-3" role="status" style="display:none"></div>
                <h4 id="diagnosisResult" class="text-muted fw-bold">En attente...</h4>
                <p class="mb-1">Confiance: <span id="confidenceScore">--</span></p>
                <div id="resultDetails" class="small text-start text-muted px-2"></div>
                <div class="mt-3">
                  <button id="viewRecommendationsBtn" class="btn btn-outline-primary btn-sm d-none"><i class="bi bi-journal-text me-1"></i> Voir Recommandations</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- container -->
    </section>

    <!-- Alertes existantes -->
    <section id="alertes-fiche-plante" class="py-5">
      <div class="container">
        <div class="glass-card p-4" data-aos="fade-up">
          <h5 class="text-warning mb-3"><i class="bi bi-bell-fill me-2"></i> Alertes Actives (Exemples)</h5>
          <ul class="list-group list-group-flush mb-3">
            <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
              <span class="text-danger"><i class="bi bi-exclamation-circle-fill me-2"></i> Salade : Mildiou d√©tect√©.</span>
              <button class="btn btn-sm btn-outline-danger view-fiche-btn">Voir Fiche</button>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
              <span class="text-warning"><i class="bi bi-info-circle-fill me-2"></i> Bl√© : Stress hydrique.</span>
              <button class="btn btn-sm btn-outline-warning view-fiche-btn">Voir Fiche</button>
            </li>
          </ul>

          <div class="text-center mt-3">
            <button id="openDashboardBtn" class="btn btn-primary btn-lg"><i class="bi bi-bar-chart-fill me-2"></i> Acc√©der au Dashboard Global</button>
          </div>
        </div>
      </div>
    </section>

    <!-- DASHBOARD qui s'affiche dynamiquement (pr√©serv√© et enrichi) -->
    <section id="dashboardSection" class="py-5" style="display:none;">
      <div class="container" data-aos="fade-up">
        <h2 class="section-heading text-center text-success"><i class="bi bi-speedometer2 me-2"></i> Tableau de Bord Sant√©</h2>
        <p class="text-center text-muted mb-4">R√©sum√© des indicateurs et rapport d'analyse automatique (int√©gration du r√©sultat de pr√©diction).</p>

        <div class="row g-4 mb-4">
          <div class="col-md-4">
            <div class="glass-card p-4 text-center">
              <h5 class="mb-2"><i class="bi bi-flower3 me-2 text-success"></i> Salade</h5>
              <p id="salade-stats" class="mb-0"></p>
            </div>
          </div>

          <div class="col-md-4">
            <div class="glass-card p-4 text-center">
              <h5 class="mb-2"><i class="bi bi-cloud-drizzle me-2 text-warning"></i> Bl√©</h5>
              <p id="ble-stats" class="mb-0"></p>
            </div>
          </div>

          <div class="col-md-4">
            <div class="glass-card p-4 text-center">
              <h5 class="mb-2"><i class="bi bi-droplet-half me-2 text-info"></i> Tomate</h5>
              <p id="tomate-stats" class="mb-0"></p>
            </div>
          </div>
        </div>

        <div class="row g-4 mb-4">
          <div class="col-lg-6">
            <div class="glass-card p-4">
              <h6 class="mb-3">√âvolution Temp√©rature (7 derniers jours)</h6>
              <canvas id="tempChart" height="180"></canvas>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="glass-card p-4">
              <h6 class="mb-3">Humidit√© par Culture</h6>
              <canvas id="humidityChart" height="180"></canvas>
            </div>
          </div>
        </div>

        <div class="glass-card p-4">
          <h4 class="mb-2 text-success"><i class="bi bi-cpu me-2"></i> Rapport IA Automatique</h4>
          <p id="ai-report" class="text-muted mb-1">Analyse en attente...</p>
          <div class="progress mt-3" style="height: 10px;">
            <div id="healthProgress" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
          </div>
          <p class="mt-2 small">Score global de sant√© : <span id="healthScore" class="fw-bold">--</span></p>

          <div id="diagnosticSummary" class="mt-3 small text-muted"></div>
        </div>
      </div>
    </section>

    <!-- Contact / Footer anchor -->
    <section id="contact" class="py-5"></section>
  </main>

  <!-- FOOTER -->
  <footer class="py-4 text-center small">
    <div class="container">
      <span class="text-muted">&copy; 2025 GreenTwin. Tous droits r√©serv√©s</span>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
  <script>AOS.init({ duration: 700, once: true });</script>

  <script>
    // CORE: conserve ton flux d'upload + diagnostic ML simul√©,
    // et ouvre le dashboard en cas de pr√©diction (ou via 'Voir Fiche' / 'Dashboard').
    document.addEventListener('DOMContentLoaded', () => {
      // Elements upload/diagnostic
      const leafImageUpload = document.getElementById('leafImageUpload');
      const imagePreview = document.getElementById('imagePreview');
      const startDiagnosisBtn = document.getElementById('startDiagnosisBtn');
      const diagnosisLoading = document.getElementById('diagnosisLoading');
      const diagnosisResult = document.getElementById('diagnosisResult');
      const confidenceScore = document.getElementById('confidenceScore');
      const resultDetails = document.getElementById('resultDetails');
      const viewRecommendationsBtn = document.getElementById('viewRecommendationsBtn');

      // Dashboard elements
      const dashboard = document.getElementById('dashboardSection');
      const openDashboardBtn = document.getElementById('openDashboardBtn');
      const viewFicheBtns = document.querySelectorAll('.view-fiche-btn');

      // Dashboard data placeholders
      const plants = {
        salade: { temp: 22, humidity: 82, state: 'Sain' },
        ble: { temp: 24, humidity: 58, state: 'Moyen' },
        tomate: { temp: 26, humidity: 70, state: 'Sain' }
      };

      // Charts
      let tempChart = null;
      let humidityChart = null;

      // Helper: render simple stat cards
      const renderStats = () => {
        document.getElementById('salade-stats').innerHTML =
          `Temp√©rature : ${plants.salade.temp}¬∞C<br>Humidit√© : ${plants.salade.humidity}%<br>√âtat : <span class="${plants.salade.state==='Sain'?'text-success':plants.salade.state==='Moyen'?'text-warning':'text-danger'}">${plants.salade.state}</span>`;

        document.getElementById('ble-stats').innerHTML =
          `Temp√©rature : ${plants.ble.temp}¬∞C<br>Humidit√© : ${plants.ble.humidity}%<br>√âtat : <span class="${plants.ble.state==='Sain'?'text-success':plants.ble.state==='Moyen'?'text-warning':'text-danger'}">${plants.ble.state}</span>`;

        document.getElementById('tomate-stats').innerHTML =
          `Temp√©rature : ${plants.tomate.temp}¬∞C<br>Humidit√© : ${plants.tomate.humidity}%<br>√âtat : <span class="${plants.tomate.state==='Sain'?'text-success':plants.tomate.state==='Moyen'?'text-warning':'text-danger'}">${plants.tomate.state}</span>`;
      };

      renderStats();

      // Build charts when dashboard opens
      function buildCharts() {
        const tempCtx = document.getElementById('tempChart').getContext('2d');
        const humidityCtx = document.getElementById('humidityChart').getContext('2d');

        // Generate 7-day temp data centred around average of plants
        const avgTemp = Math.round((plants.salade.temp + plants.ble.temp + plants.tomate.temp) / 3);
        const tempData = Array.from({length:7}, (_,i)=>avgTemp + Math.round((Math.sin(i/2)+Math.random()-0.4)*2));

        if (tempChart) tempChart.destroy();
        tempChart = new Chart(tempCtx, {
          type: 'line',
          data: {
            labels: ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'],
            datasets: [{
              label: 'Temp (¬∞C)',
              data: tempData,
              borderColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-green') || '#2e8b57',
              backgroundColor: 'rgba(46,139,87,0.12)',
              tension: 0.3,
              fill: true
            }]
          },
          options: { plugins:{legend:{display:false}}, scales:{y:{beginAtZero:false}} }
        });

        const humData = [plants.salade.humidity, plants.ble.humidity, plants.tomate.humidity];

        if (humidityChart) humidityChart.destroy();
        humidityChart = new Chart(humidityCtx, {
          type: 'bar',
          data: {
            labels: ['Salade','Bl√©','Tomate'],
            datasets: [{
              label: 'Humidit√© (%)',
              data: humData,
              backgroundColor: ['#9bd6b8','#ffc107','#2e8b57']
            }]
          },
          options: { plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
        });
      }

      // Function to compute health score & AI report based on plants + diagnosis
      function computeAIReport(prediction) {
        // prediction: {label, confidence, details}
        // Build a synthetic score using humidity and prediction severity
        const avgHum = (plants.salade.humidity + plants.ble.humidity + plants.tomate.humidity)/3;
        let base = Math.round(avgHum); // 0-100-ish
        // adjust by temps closeness to ideal (24¬∞C)
        const avgTemp = (plants.salade.temp + plants.ble.temp + plants.tomate.temp)/3;
        base += Math.max(-10, 10 - Math.abs(24 - avgTemp)); // penalize large temp diff
        // adjust by prediction: severe disease reduces score
        let predPenalty = 0;
        let summary = '';
        if (prediction) {
          const label = prediction.label.toLowerCase();
          const conf = Math.round(prediction.confidence*100);
          summary = `Pr√©diction ML : ${prediction.label} (confiance ${conf}%). ${prediction.details}`;
          if (label.includes('mildiou') || label.includes('infect')) predPenalty = 25;
          else if (label.includes('stress')) predPenalty = 10;
          else predPenalty = 0;
          // map higher confidence => larger penalty
          predPenalty = Math.round(predPenalty * prediction.confidence);
        }

        let score = Math.max(10, Math.min(98, Math.round((base - predPenalty))));
        // set textual message
        let msg = '';
        if (score > 80) msg = "üåø Conditions excellentes ‚Äî surveillance r√©guli√®re recommand√©e.";
        else if (score > 60) msg = "‚ö†Ô∏è Conditions correctes ‚Äî prenez des mesures pr√©ventives sur les parcelles signal√©es.";
        else msg = "üö® Risque important ‚Äî intervention recommand√©e sur les parcelles affect√©es.";

        // Update UI
        document.getElementById('healthScore').textContent = score + '%';
        const progressBar = document.getElementById('healthProgress');
        progressBar.style.width = score + '%';
        progressBar.className = 'progress-bar ' + (score > 80 ? 'bg-success' : score > 60 ? 'bg-warning' : 'bg-danger');
        document.getElementById('ai-report').textContent = msg;
        document.getElementById('diagnosticSummary').innerHTML = prediction ? `<strong>R√©sum√© pr√©diction :</strong> ${summary}` : `<strong>R√©sum√© :</strong> Pas de diagnostic disponible.`;

        return {score, msg, summary};
      }

      // Open dashboard helper: render charts and compute report
      function openDashboard(withPrediction) {
        // if dashboard hidden -> display
        dashboard.style.display = 'block';
        // update UI stats & charts
        renderStats();
        buildCharts();
        // compute report
        computeAIReport(withPrediction);
        // smooth scroll
        setTimeout(()=> dashboard.scrollIntoView({behavior:'smooth'}), 80);
      }

      // Upload handling (same flow)
      let uploadedFile = null;
      leafImageUpload.addEventListener('change', (ev) => {
        const file = ev.target.files[0];
        if (!file) return;
        // simple size guard
        if (file.size > 5 * 1024 * 1024) {
          alert('Le fichier est trop volumineux (max 5MB).');
          leafImageUpload.value = '';
          startDiagnosisBtn.disabled = true;
          imagePreview.src = "https://placehold.co/400x300/e9ecef/212529?text=Fichier+trop+volumineux";
          return;
        }
        uploadedFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
          imagePreview.src = e.target.result;
          startDiagnosisBtn.disabled = false;
          // reset result display
          diagnosisResult.textContent = 'En attente...';
          diagnosisResult.className = 'text-muted fw-bold';
          confidenceScore.textContent = '--';
          resultDetails.innerHTML = '';
          viewRecommendationsBtn.classList.add('d-none');
        };
        reader.readAsDataURL(file);
      });

      // Simulated ML prediction outcomes
      const simulatedResults = [
        { label: "Feuille Sain", confidence: 0.96, details: "Aucun signe de maladie d√©tect√©." },
        { label: "Mildiou (Tomate/Salade)", confidence: 0.93, details: "Infection fongique : traiter avec fongicide biologique." },
        { label: "Stress Hydrique", confidence: 0.88, details: "Niveaux d'humidit√© bas, augmenter irrigation cibl√©e." },
        { label: "Carence en Azote", confidence: 0.82, details: "Feuilles jaunies : apport d'azote recommand√©." }
      ];

      // Start diagnosis: simulate ML processing then show result and open dashboard
      startDiagnosisBtn.addEventListener('click', () => {
        if (!uploadedFile) return;
        startDiagnosisBtn.disabled = true;
        diagnosisLoading.style.display = 'inline-block';
        diagnosisResult.textContent = 'Analyse de l\'image...';
        confidenceScore.textContent = '--';
        resultDetails.innerHTML = '';

        // Simulate processing latency
        setTimeout(() => {
          diagnosisLoading.style.display = 'none';
          // choose random result biased slightly to detect issues sometimes
          const pick = simulatedResults[Math.floor(Math.random() * simulatedResults.length)];
          // show result
          diagnosisResult.textContent = pick.label;
          diagnosisResult.className = pick.label.toLowerCase().includes('sain') ? 'text-success fw-bold' :
                                      pick.label.toLowerCase().includes('mildiou') ? 'text-danger fw-bold' :
                                      'text-warning fw-bold';
          confidenceScore.textContent = Math.round(pick.confidence * 100) + '%';
          resultDetails.innerHTML = `<p class="mb-0">${pick.details}</p>`;
          viewRecommendationsBtn.classList.remove('d-none');

          // Update plants data to reflect diagnosis (basic mapping)
          if (pick.label.toLowerCase().includes('mildiou')) {
            plants.salade.state = 'Affect√©e';
            plants.salade.humidity = Math.min(95, plants.salade.humidity + 5);
            // reflect more negative state
          } else if (pick.label.toLowerCase().includes('stress')) {
            plants.ble.state = 'Stress';
            plants.ble.humidity = Math.max(30, plants.ble.humidity - 12);
          } else if (pick.label.toLowerCase().includes('carence')) {
            plants.tomate.state = 'Carence';
            plants.tomate.temp = Math.max(18, plants.tomate.temp - 1);
          } else if (pick.label.toLowerCase().includes('sain')) {
            // small positive tweak
            plants.salade.state = 'Sain';
            plants.ble.state = 'Sain';
            plants.tomate.state = 'Sain';
          }

          // open dashboard and pass prediction so the AI report includes it
          openDashboard(pick);

          // re-enable button text
          startDiagnosisBtn.disabled = false;
        }, 2200);
      });

      // View recommendations opens dashboard and scrolls (keeps result present)
      viewRecommendationsBtn.addEventListener('click', () => {
        // Build a lightweight "prediction" object from current UI
        const pred = {
          label: diagnosisResult.textContent || null,
          confidence: parseFloat((confidenceScore.textContent || '0').replace('%',''))/100 || 0,
          details: resultDetails.textContent || ''
        };
        openDashboard(pred.label ? pred : null);
      });

      // "Voir fiche" buttons reveal the dashboard (no prediction) but it will show current summary
      viewFicheBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          openDashboard(null);
        });
      });

      // open dashboard global button
      openDashboardBtn.addEventListener('click', () => openDashboard(null));
    });
  </script>
</body>
</html>
